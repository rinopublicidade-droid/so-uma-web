<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Só Uma — Multiplayer (Host/Dicas/Adivinhador)</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;--bg:#0b0f17;--card:#101a2b;--stroke:rgba(255,255,255,.12);--text:#f3f6ff;--muted:rgba(243,246,255,.75)}
    body{margin:0;background:radial-gradient(1100px 700px at 20% 10%, rgba(255,210,90,.14), transparent 55%),
                 radial-gradient(900px 650px at 80% 20%, rgba(90,200,255,.12), transparent 55%),
                 linear-gradient(180deg,#0e1630,var(--bg));color:var(--text);min-height:100vh}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),transparent 35%),var(--card);border:1px solid var(--stroke);border-radius:18px;padding:16px;box-shadow:0 18px 60px rgba(0,0,0,.45)}
    h1{margin:0 0 6px;font-size:20px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid var(--stroke);font-size:13px}
    button,input{border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.09);color:var(--text);padding:10px 12px;font-weight:800}
    button{cursor:pointer}
    button:hover{background:rgba(255,255,255,.13)}
    input{width:min(360px,100%);background:rgba(0,0,0,.18);font-weight:800}
    .words{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .word{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center;text-transform:uppercase;font-weight:900}
    .idx{opacity:.85;font-size:12px;font-weight:1000;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.22);background:rgba(0,0,0,.18)}
    .panel{margin-top:12px;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18)}
    .clues{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .clue{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06)}
    .small{font-size:12px;color:var(--muted)}
    .danger{background:rgba(255,90,90,.14);border-color:rgba(255,90,90,.35)}
    .ok{background:rgba(90,255,190,.10);border-color:rgba(90,255,190,.25)}
    code{color:#fff; word-break: break-all;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Só Uma — Multiplayer</h1>
      <p class="sub">
        Um celular vira <b>Host</b> (sorteia carta e alvo), os jogadores entram como <b>Dicas</b> (veem o alvo e mandam a dica),
        e o <b>Adivinhador</b> entra num link separado (vê só as dicas).
      </p>

      <div class="row">
        <span class="pill">Modo: <b id="mode">—</b></span>
        <span class="pill">Sala: <b id="room">—</b></span>
        <span class="pill">Rodada: <b id="round">—</b></span>
      </div>

      <div id="hostUI" style="display:none">
        <div class="row">
          <button id="newRoomBtn" class="ok">Criar nova sala</button>
          <button id="newCardBtn">Nova carta</button>
          <button id="pickBtn">Sortear alvo (1–5)</button>
          <button id="clearCluesBtn" class="danger">Limpar dicas</button>
        </div>

        <div class="panel">
          <div class="small">Links da sala (copie/mande no WhatsApp):</div>
          <div class="small">Dicas: <code id="linkClue">—</code></div>
          <div class="small">Adivinhador: <code id="linkGuess">—</code></div>
        </div>

        <div class="words" id="words"></div>

        <div class="panel" id="targetBox" style="display:none">
          <div><b>Alvo:</b> <span id="targetWord">—</span> <span class="small">(nº <span id="targetN">—</span>)</span></div>
        </div>

        <div class="panel">
          <div><b>Dicas recebidas:</b></div>
          <div class="clues" id="clueList"></div>
          <div class="small" id="dupHint" style="margin-top:8px"></div>
        </div>
      </div>

      <div id="clueUI" style="display:none">
        <div class="panel">
          <div class="small">Palavra-alvo (só quem dá dica vê):</div>
          <div style="font-size:22px;font-weight:1000;text-transform:uppercase;margin-top:6px" id="clueTarget">—</div>
          <div class="small" style="margin-top:8px">Envie <b>uma palavra</b> como dica:</div>
          <div class="row">
            <input id="clueName" placeholder="Seu nome (opcional)" />
            <input id="clueText" placeholder="Sua dica (1 palavra)" />
            <button id="sendClueBtn" class="ok">Enviar</button>
          </div>
          <div class="small" id="clueStatus"></div>
        </div>
      </div>

      <div id="guessUI" style="display:none">
        <div class="panel">
          <div class="small">Adivinhador: você vê <b>só as dicas</b>.</div>
          <div style="margin-top:10px"><b>Dicas:</b></div>
          <div class="clues" id="guessClueList"></div>
        </div>
      </div>

      <div id="helpUI" class="panel" style="display:none">
        <div><b>Como abrir:</b></div>
        <div class="small">
          Host: <code>?role=host</code> • Dicas: <code>?role=clue&room=XXXX</code> • Adivinhador: <code>?role=guess&room=XXXX</code>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ======= FIREBASE CONFIG (SEU) =======
    const firebaseConfig = {
      apiKey: "AIzaSyBnFKG9BmzKV4zWcSaZ59qiEaSX6rRwAuo",
      authDomain: "so-uma-game.firebaseapp.com",
      projectId: "so-uma-game",
      storageBucket: "so-uma-game.firebasestorage.app",
      messagingSenderId: "492239204930",
      appId: "1:492239204930:web:b96a42d1cdb80b86b3b3db"
    };

    // ======= IMPORTS FIREBASE =======
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot,
      collection, addDoc, serverTimestamp, deleteDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ======= BARALHO COMPLETO (110 CARTAS) =======
    const DECK = [
      // 1 - 30
      ["Sol","Praia","Calor","Verão","Bronzeado"],
      ["Cachorro","Latido","Coleira","Osso","Amigo"],
      ["Escola","Professor","Aula","Prova","Caderno"],
      ["Pizza","Forno","Mussarela","Fatia","Itália"],
      ["Chuva","Guarda-chuva","Molhado","Nuvem","Temporal"],
      ["Futebol","Gol","Torcida","Estádio","Bola"],
      ["Celular","Tela","Aplicativo","Mensagem","Bateria"],
      ["Café","Xícara","Amargo","Manhã","Energia"],
      ["Viagem","Mala","Avião","Hotel","Férias"],
      ["Médico","Hospital","Consulta","Receita","Saúde"],
      ["Livro","Página","Autor","Leitura","Biblioteca"],
      ["Festa","Música","Dança","Balão","Alegria"],
      ["Frio","Casaco","Inverno","Cachecol","Geada"],
      ["Cinema","Filme","Pipoca","Tela","Sessão"],
      ["Relógio","Hora","Atraso","Ponteiro","Alarme"],
      ["Criança","Brinquedo","Escola","Sorriso","Parquinho"],
      ["Dinheiro","Carteira","Compra","Preço","Troco"],
      ["Natal","Presente","Papai Noel","Árvore","Família"],
      ["Internet","Wi-Fi","Conexão","Site","Senha"],
      ["Cozinha","Fogão","Receita","Panela","Temperar"],
      ["Trânsito","Semáforo","Engarrafamento","Buzina","Rua"],
      ["Amizade","Confiança","Risada","Apoio","Companhia"],
      ["Academia","Peso","Treino","Suor","Músculo"],
      ["Praia","Areia","Onda","Mar","Protetor"],
      ["Professor","Lousa","Explicação","Prova","Ensino"],
      ["Festa Junina","Fogueira","Milho","Quadrilha","Balão"],
      ["Trabalho","Reunião","Prazo","Meta","Resultado"],
      ["Cidade","Rua","Bairro","Praça","Movimento"],
      ["Sorvete","Frio","Doce","Casquinha","Verão"],
      ["Amor","Coração","Cuidado","Abraço","Afeto"],

      // 31 - 110
      ["Música","Fone","Volume","Playlist","Ritmo"],
      ["Chave","Porta","Fechadura","Cadeado","Acesso"],
      ["Mercado","Carrinho","Oferta","Caixa","Compra"],
      ["Escola","Recreio","Amigo","Brincadeira","Intervalo"],
      ["Médico","Estetoscópio","Batimento","Exame","Diagnóstico"],
      ["Filme","Diretor","Cena","Ator","Oscar"],
      ["Criança","Colo","Cuidado","Choro","Carinho"],
      ["Foto","Câmera","Clique","Álbum","Memória"],
      ["Rua","Calçada","Pedestre","Faixa","Trânsito"],
      ["Estudo","Foco","Concentração","Silêncio","Resultado"],
      ["Praia","Cadeira","Guarda-sol","Descanso","Brisa"],
      ["Cama","Travesseiro","Sono","Descanso","Sonho"],
      ["Restaurante","Cardápio","Garçom","Pedido","Conta"],
      ["Igreja","Fé","Oração","Louvor","Esperança"],
      ["Aniversário","Bolo","Vela","Parabéns","Festa"],
      ["Chuva","Poça","Guarda-chuva","Pingos","Molhado"],
      ["Escritório","Computador","Mesa","Relatório","Trabalho"],
      ["Jantar","Mesa","Família","Conversa","Refeição"],
      ["Hospital","Enfermagem","Plantão","Emergência","Cuidado"],
      ["Brinquedo","Quebra-cabeça","Peça","Montar","Paciência"],
      ["Religião","Bíblia","Ensino","Palavra","Amor"],
      ["Avião","Decolagem","Asa","Viagem","Altura"],
      ["Cabelo","Escova","Corte","Espelho","Salão"],
      ["Compras","Sacola","Loja","Promoção","Preço"],
      ["Escola","Lápis","Borracha","Escrita","Caderno"],
      ["Verão","Piscina","Mergulho","Frescor","Sol"],
      ["Inverno","Cobertor","Frio","Preguiça","Chocolate"],
      ["Festa","Convite","Lista","Amigos","Encontro"],
      ["Bicicleta","Pedal","Equilíbrio","Capacete","Passeio"],
      ["Professor","Explicação","Quadro","Aula","Ensino"],
      ["Dinheiro","Banco","Cartão","Senha","Conta"],
      ["Televisão","Controle","Canal","Volume","Sofá"],
      ["Viagem","Estrada","Parada","Destino","Caminho"],
      ["Feira","Barraca","Fruta","Feira-livre","Sacola"],
      ["Cozinha","Prato","Talher","Receita","Sabor"],
      ["Academia","Esteira","Corrida","Fôlego","Suor"],
      ["Criança","Escola","Mochila","Lanche","Aprender"],
      ["Casamento","Aliança","Amor","Festa","União"],
      ["Internet","Vídeo","Curtida","Comentário","Compartilhar"],
      ["Trânsito","Farol","Parada","Atenção","Sinal"],
      ["Almoço","Arroz","Feijão","Prato","Caseiro"],
      ["Escola","Prova","Nota","Estudo","Resultado"],
      ["Noite","Silêncio","Lua","Estrelas","Descanso"],
      ["Trabalho","Esforço","Dedicação","Meta","Conquista"],
      ["Criança","Desenho","Lápis","Cor","Criatividade"],
      ["Natal","Ceia","Família","União","Gratidão"],
      ["Ano Novo","Esperança","Recomeço","Planos","Futuro"],
      ["Escola","Formatura","Diploma","Orgulho","Conquista"],
      ["Campo","Grama","Ar Livre","Natureza","Descanso"],
      ["Carro","Volante","Estrada","Direção","Viagem"],
      ["Cachorro","Passeio","Guia","Rua","Alegria"],
      ["Gato","Bigode","Sofá","Preguiça","Miado"],
      ["Churrasco","Grelha","Carne","Amigos","Fim de semana"],
      ["Escola","Amizade","Grupo","Trabalho","União"],
      ["Cuidado","Atenção","Respeito","Empatia","Amor"],
      ["Parque","Árvore","Banco","Caminhada","Lazer"],
      ["Celular","Notificação","Mensagem","Alerta","Som"],
      ["Manhã","Despertador","Sono","Café","Pressa"],
      ["Tarde","Trabalho","Sol","Movimento","Rotina"],
      ["Noite","Jantar","Descanso","Família","Conversa"],
      ["Escola","Biblioteca","Silêncio","Leitura","Estudo"],
      ["Praia","Caminhada","Areia","Pegada","Mar"],
      ["Feira","Pastel","Caldo","Encontro","Tradição"],
      ["Trabalho","Equipe","União","Resultado","Sucesso"],
      ["Criança","Colo","Proteção","Segurança","Amor"],
      ["Escola","Professor","Inspiração","Ensino","Futuro"],
      ["Cidade","Bairro","Comunidade","Pessoas","Vida"],
      ["Igreja","Comunhão","Encontro","Palavra","Fé"],
      ["Casa","Lar","Aconchego","Segurança","Família"],
      ["Amigo","Confiança","Conversa","Apoio","Verdade"],
      ["Trabalho","Horário","Compromisso","Rotina","Disciplina"],
      ["Escola","Educação","Base","Conhecimento","Futuro"],
      ["Festa","Música","Dança","Energia","Alegria"],
      ["Silêncio","Paz","Calma","Tranquilidade","Equilíbrio"],
      ["Desafio","Superação","Força","Persistência","Vitória"],
      ["Esperança","Fé","Confiança","Caminho","Luz"],
      ["Gratidão","Reconhecimento","Respeito","Amor","Valor"],
      ["Futuro","Sonho","Planejamento","Dedicação","Conquista"],
      ["Vida","Tempo","Escolhas","Caminhos","Aprendizado"],
      ["Jogo","Diversão","Risada","Amigos","Memória"],
    ];

    // ======= HELPERS / UI =======
    const qs = new URLSearchParams(location.search);
    const role = (qs.get("role") || "").toLowerCase(); // host | clue | guess
    const roomParam = (qs.get("room") || "").toUpperCase();

    const elMode = document.getElementById("mode");
    const elRoom = document.getElementById("room");
    const elRound = document.getElementById("round");

    const hostUI = document.getElementById("hostUI");
    const clueUI = document.getElementById("clueUI");
    const guessUI = document.getElementById("guessUI");
    const helpUI = document.getElementById("helpUI");

    const elWords = document.getElementById("words");
    const elTargetBox = document.getElementById("targetBox");
    const elTargetWord = document.getElementById("targetWord");
    const elTargetN = document.getElementById("targetN");

    const linkClue = document.getElementById("linkClue");
    const linkGuess = document.getElementById("linkGuess");

    const clueList = document.getElementById("clueList");
    const guessClueList = document.getElementById("guessClueList");
    const dupHint = document.getElementById("dupHint");

    const clueTarget = document.getElementById("clueTarget");
    const clueName = document.getElementById("clueName");
    const clueText = document.getElementById("clueText");
    const clueStatus = document.getElementById("clueStatus");

    function fisherYates(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function code4(){
      const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<4;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function baseUrl(){ return location.origin + location.pathname; }
    function makeLink(r, rm){ return `${baseUrl()}?role=${r}&room=${rm}`; }

    function renderWords(words){
      elWords.innerHTML = "";
      (words || []).forEach((w,i)=>{
        const div = document.createElement("div");
        div.className = "word";
        div.innerHTML = `<span>${w}</span><span class="idx">${i+1}</span>`;
        elWords.appendChild(div);
      });
    }
    function normalizeClue(s){ return (s||"").trim().toLowerCase(); }

    // ======= FIREBASE INIT =======
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ======= FIRESTORE REFS =======
    function roomRef(rm){ return doc(db, "rooms", rm); }
    function cluesColRef(rm){ return collection(db, "rooms", rm, "clues"); }

    // ======= GAME STATE (host) =======
    let room = roomParam || "";
    let deckOrder = []; // array de índices das cartas
    let deckPos = 0;

    // ======= ACTIONS =======
    async function createRoom(){
      room = code4();
      deckOrder = fisherYates([...DECK.keys()]);
      deckPos = 0;

      const firstIdx = deckOrder[deckPos];
      await setDoc(roomRef(room), {
        room,
        round: 1,
        card: DECK[firstIdx],
        cardIndex: firstIdx,
        targetN: null,
        targetWord: null,
        deckOrder,
        deckPos,
        updatedAt: serverTimestamp()
      });

      // Atualiza URL do host
      history.replaceState(null, "", makeLink("host", room));
      setupUI();
      attachListeners();
    }

    async function nextCard(){
      const snap = await getDoc(roomRef(room));
      if (!snap.exists()) return;

      const data = snap.data();
      let order = Array.isArray(data.deckOrder) ? data.deckOrder : fisherYates([...DECK.keys()]);
      let pos = Number.isFinite(data.deckPos) ? data.deckPos : 0;

      pos = (pos + 1) % order.length;
      const cardIdx = order[pos];

      await setDoc(roomRef(room), {
        round: (data.round || 1) + 1,
        card: DECK[cardIdx],
        cardIndex: cardIdx,
        targetN: null,
        targetWord: null,
        deckOrder: order,
        deckPos: pos,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function pickTarget(){
      const snap = await getDoc(roomRef(room));
      if (!snap.exists()) return;
      const data = snap.data();
      const card = data.card;

      if (!Array.isArray(card) || card.length !== 5) return;

      const n = Math.floor(Math.random()*5)+1;
      const tw = card[n-1];

      await setDoc(roomRef(room), {
        targetN: n,
        targetWord: tw,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function clearClues(){
      const col = cluesColRef(room);
      const all = await getDocs(col);
      await Promise.all(all.docs.map(d => deleteDoc(d.ref)));
    }

    async function sendClue(){
      const name = (clueName.value || "").trim();
      const txt = (clueText.value || "").trim();
      if (!txt) { clueStatus.textContent = "Digite sua dica."; return; }

      // força “1 palavra”
      const oneWord = txt.split(/\s+/)[0];

      await addDoc(cluesColRef(room), {
        name: name || "Jogador",
        clue: oneWord,
        clueNorm: normalizeClue(oneWord),
        createdAt: serverTimestamp()
      });

      clueText.value = "";
      clueStatus.textContent = "Dica enviada ✅";
      setTimeout(()=>clueStatus.textContent="", 1400);
    }

    // ======= REALTIME LISTENERS =======
    function attachListeners(){
      onSnapshot(roomRef(room), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();

        elRoom.textContent = room;
        elRound.textContent = String(data.round ?? "—");

        const card = data.card || [];
        const tn = data.targetN;
        const tw = data.targetWord;

        linkClue.textContent = makeLink("clue", room);
        linkGuess.textContent = makeLink("guess", room);

        if (role === "host"){
          renderWords(card);
          if (tw){
            elTargetBox.style.display = "block";
            elTargetWord.textContent = tw;
            elTargetN.textContent = String(tn);
          } else {
            elTargetBox.style.display = "none";
            elTargetWord.textContent = "—";
            elTargetN.textContent = "—";
          }
        }

        if (role === "clue"){
          clueTarget.textContent = tw ? tw : "Aguardando alvo…";
        }
      });

      onSnapshot(cluesColRef(room), (snap) => {
        const items = [];
        snap.forEach(d => items.push({ id:d.id, ...d.data() }));

        items.sort((a,b)=>{
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return ta - tb;
        });

        const normCount = new Map();
        items.forEach(it=>{
          const k = it.clueNorm || normalizeClue(it.clue);
          normCount.set(k, (normCount.get(k)||0) + 1);
        });

        function renderClueList(targetEl){
          targetEl.innerHTML = "";
          items.forEach(it=>{
            const key = it.clueNorm || normalizeClue(it.clue);
            const dup = (normCount.get(key) || 0) > 1;
            const div = document.createElement("div");
            div.className = "clue";
            div.innerHTML = `<span><b>${it.name||"Jogador"}:</b> ${it.clue||""}</span>
                             <span class="small">${dup ? "duplicada ⚠️" : ""}</span>`;
            targetEl.appendChild(div);
          });
        }

        if (role === "host"){
          renderClueList(clueList);
          const dups = [...normCount.entries()].filter(([_,v])=>v>1).map(([k])=>k);
          dupHint.textContent = dups.length ? `Duplicadas: ${dups.join(", ")}` : "Sem duplicadas (por enquanto).";
        }
        if (role === "guess"){
          renderClueList(guessClueList);
        }
      });
    }

    function setupUI(){
      elRoom.textContent = room || "—";
      elMode.textContent = role ? role.toUpperCase() : "—";

      hostUI.style.display = "none";
      clueUI.style.display = "none";
      guessUI.style.display = "none";
      helpUI.style.display = "none";

      if (role === "host") hostUI.style.display = "block";
      else if (role === "clue") clueUI.style.display = "block";
      else if (role === "guess") guessUI.style.display = "block";
      else helpUI.style.display = "block";
    }

    // ======= BUTTONS =======
    document.getElementById("newRoomBtn").addEventListener("click", createRoom);
    document.getElementById("newCardBtn").addEventListener("click", nextCard);
    document.getElementById("pickBtn").addEventListener("click", pickTarget);
    document.getElementById("clearCluesBtn").addEventListener("click", clearClues);
    document.getElementById("sendClueBtn").addEventListener("click", sendClue);

    // ======= INIT =======
    setupUI();

    if (role === "host" && !room){
      await createRoom();
    } else if ((role === "clue" || role === "guess" || role === "host") && room){
      attachListeners();
    }
  </script>
</body>
</html>
