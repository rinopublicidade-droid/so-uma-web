<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>S√≥ Uma ‚Äî Multiplayer (Host/Dicas/Adivinhador)</title>
  <style>
    :root{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --bg:#0b0f17; --card:#101a2b; --stroke:rgba(255,255,255,.12);
      --text:#f3f6ff; --muted:rgba(243,246,255,.75);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    body{
      margin:0;
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(255,210,90,.14), transparent 55%),
        radial-gradient(900px 650px at 80% 20%, rgba(90,200,255,.12), transparent 55%),
        linear-gradient(180deg,#0e1630,var(--bg));
      color:var(--text);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{
      background: linear-gradient(180deg,rgba(255,255,255,.06),transparent 35%), var(--card);
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    h1{margin:0 0 6px;font-size:20px}
    .sub{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 12px;border-radius:999px;
      background:rgba(255,255,255,.07);
      border:1px solid var(--stroke);
      font-size:13px
    }
    button,input{
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.09);
      color:var(--text);
      padding:10px 12px;
      font-weight:800;
    }
    button{cursor:pointer}
    button:hover{background:rgba(255,255,255,.13)}
    button:disabled{opacity:.55; cursor:not-allowed}
    input{
      width:min(360px,100%);
      background:rgba(0,0,0,.18);
      font-weight:800
    }
    .words{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .word{
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      display:flex;justify-content:space-between;align-items:center;
      text-transform:uppercase;font-weight:900;
    }
    .idx{
      opacity:.85;font-size:12px;font-weight:1000;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(0,0,0,.18)
    }
    .panel{
      margin-top:12px;padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18)
    }
    .clues{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .clue{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06)
    }
    .small{font-size:12px;color:var(--muted)}
    .danger{background:rgba(255,90,90,.14);border-color:rgba(255,90,90,.35)}
    .ok{background:rgba(90,255,190,.10);border-color:rgba(90,255,190,.25)}
    .warn{background:rgba(255,206,86,.10);border-color:rgba(255,206,86,.25)}
    code{color:#fff; word-break: break-all;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 10px}
    @media (max-width:760px){ .grid2{grid-template-columns:1fr} }
    .divider{height:1px;background:rgba(255,255,255,.10);margin:10px 0}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      font-size:12px; color: rgba(243,246,255,.85);
      user-select:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>S√≥ Uma ‚Äî Multiplayer</h1>
      <p class="sub">
        <b>Host</b> sorteia a carta e o alvo. Jogadores entram em <b>Dicas</b> (veem o alvo e enviam 1 palavra).
        Quando todos enviarem, o Host clica <b>Revelar dicas</b>, escolhe quais v√£o valer e ent√£o clica <b>Enviar pro adivinhador</b>.
        O <b>Adivinhador</b> v√™ apenas as dicas selecionadas.
      </p>

      <div class="row">
        <span class="pill">Modo: <b id="mode">‚Äî</b></span>
        <span class="pill">Sala: <b id="room">‚Äî</b></span>
        <span class="pill">Rodada: <b id="round">‚Äî</b></span>
        <span class="pill">Fase: <b id="phaseLabel">‚Äî</b></span>
      </div>

      <!-- HOST -->
      <div id="hostUI" style="display:none">
        <div class="row">
          <button id="newRoomBtn" class="ok">Criar nova sala</button>
          <button id="newCardBtn">Nova carta</button>
          <button id="pickBtn">Sortear alvo (1‚Äì5)</button>
          <button id="revealCluesBtn" class="warn">Revelar dicas</button>
          <button id="publishCluesBtn" class="ok">Enviar pro adivinhador</button>
          <button id="clearCluesBtn" class="danger">Limpar dicas</button>
        </div>

        <div class="panel">
          <div class="small">Links da sala (copie/mande no WhatsApp):</div>
          <div class="small">Dicas: <code id="linkClue">‚Äî</code></div>
          <div class="small">Adivinhador: <code id="linkGuess">‚Äî</code></div>
        </div>

        <div class="grid2">
          <div class="panel">
            <div class="row" style="margin:0 0 6px">
              <span class="tag">üÉè Carta</span>
              <span class="small">As 5 op√ß√µes (s√≥ o Host v√™)</span>
            </div>
            <div class="words" id="words"></div>
            <div class="panel" id="targetBox" style="display:none; margin-top:12px">
              <div><b>Alvo:</b> <span id="targetWord">‚Äî</span> <span class="small">(n¬∫ <span id="targetN">‚Äî</span>)</span></div>
            </div>
          </div>

          <div class="panel">
            <div class="row" style="margin:0 0 6px">
              <span class="tag">üí¨ Dicas</span>
              <span class="small" id="clueCountText">‚Äî</span>
            </div>

            <div class="small" id="cluesHiddenHint" style="display:none">
              As dicas ficam <b>ocultas</b> at√© voc√™ clicar em <b>Revelar dicas</b>.
            </div>

            <div class="divider"></div>

            <div id="hostCluesArea">
              <div class="small" id="hostCluesHelp" style="display:none">
                Marque as dicas que voc√™ quer mandar para o adivinhador e clique em <b>Enviar pro adivinhador</b>.
              </div>
              <div class="clues" id="clueList"></div>
              <div class="small" id="dupHint" style="margin-top:8px"></div>
              <div class="row" style="margin-top:10px; display:none" id="bulkRow">
                <button id="selectAllBtn">Marcar todas</button>
                <button id="unselectAllBtn">Desmarcar todas</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- DICAS -->
      <div id="clueUI" style="display:none">
        <div class="panel">
          <div class="small">Palavra-alvo (s√≥ quem d√° dica v√™):</div>
          <div style="font-size:22px;font-weight:1000;text-transform:uppercase;margin-top:6px" id="clueTarget">‚Äî</div>
          <div class="small" style="margin-top:8px">Envie <b>uma palavra</b> como dica:</div>
          <div class="row">
            <input id="clueName" placeholder="Seu nome (opcional)" />
            <input id="clueText" placeholder="Sua dica (1 palavra)" />
            <button id="sendClueBtn" class="ok">Enviar</button>
          </div>
          <div class="small" id="clueStatus"></div>
        </div>
      </div>

      <!-- ADIVINHADOR -->
      <div id="guessUI" style="display:none">
        <div class="panel">
          <div class="small">Adivinhador: voc√™ v√™ <b>apenas</b> as dicas que o Host selecionar e enviar.</div>
          <div class="divider"></div>
          <div class="small" id="guessWait">Aguardando o host enviar as dicas‚Ä¶</div>
          <div class="clues" id="guessClueList"></div>
        </div>
      </div>

      <!-- AJUDA -->
      <div id="helpUI" class="panel" style="display:none">
        <div><b>Como abrir:</b></div>
        <div class="small">
          Host: <code>?role=host</code> ‚Ä¢ Dicas: <code>?role=clue&room=XXXX</code> ‚Ä¢ Adivinhador: <code>?role=guess&room=XXXX</code>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ======= FIREBASE CONFIG (SEU) =======
    const firebaseConfig = {
      apiKey: "AIzaSyBnFKG9BmzKV4zWcSaZ59qiEaSX6rRwAuo",
      authDomain: "so-uma-game.firebaseapp.com",
      projectId: "so-uma-game",
      storageBucket: "so-uma-game.firebasestorage.app",
      messagingSenderId: "492239204930",
      appId: "1:492239204930:web:b96a42d1cdb80b86b3b3db"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot,
      collection, addDoc, serverTimestamp, deleteDoc, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ======= BARALHO (110 CARTAS ORIGINAIS) =======
    // Observa√ß√£o: n√£o inclui conte√∫do oficial do jogo; s√£o cartas originais no mesmo formato (5 op√ß√µes).
    const DECK = [
      ["SOL","PRAIA","CALOR","VER√ÉO","BRONZEADO"],
      ["CACHORRO","LATIDO","COLEIRA","OSSO","AMIGO"],
      ["ESCOLA","PROFESSOR","AULA","PROVA","CADERNO"],
      ["PIZZA","FORNO","MUSSARELA","FATIA","IT√ÅLIA"],
      ["CHUVA","GUARDA-CHUVA","MOLHADO","NUVEM","TEMPORAL"],
      ["FUTEBOL","GOL","TORCIDA","EST√ÅDIO","BOLA"],
      ["CELULAR","TELA","APLICATIVO","MENSAGEM","BATERIA"],
      ["CAF√â","X√çCARA","AMARGO","MANH√É","ENERGIA"],
      ["VIAGEM","MALA","AVI√ÉO","HOTEL","F√âRIAS"],
      ["M√âDICO","HOSPITAL","CONSULTA","RECEITA","SA√öDE"],
      ["LIVRO","P√ÅGINA","AUTOR","LEITURA","BIBLIOTECA"],
      ["FESTA","M√öSICA","DAN√áA","BRILHO","ALEGRIA"],
      ["FRIO","CASACO","INVERNO","CACHECOL","GEADA"],
      ["CINEMA","FILME","PIPOCA","TELA","SESS√ÉO"],
      ["REL√ìGIO","HORA","ATRASO","ALARME","PONTEIRO"],
      ["CRIAN√áA","BRINQUEDO","SORRISO","PARQUINHO","BAGUN√áA"],
      ["DINHEIRO","CARTEIRA","COMPRA","PRE√áO","TROCO"],
      ["NATAL","PRESENTE","√ÅRVORE","CEIA","FAM√çLIA"],
      ["INTERNET","WI-FI","CONEX√ÉO","SITE","SENHA"],
      ["COZINHA","FOG√ÉO","RECEITA","PANELA","TEMPERAR"],
      ["TR√ÇNSITO","SEM√ÅFORO","ENGARRAFAMENTO","BUZINA","RUA"],
      ["AMIZADE","CONFIAN√áA","RISADA","APOIO","COMPANHIA"],
      ["ACADEMIA","PESO","TREINO","SUOR","M√öSCULO"],
      ["MAR","AREIA","ONDA","BRISA","PROTETOR"],
      ["PROFESSOR","LOUSA","EXPLICA√á√ÉO","ENSINO","NOTA"],
      ["FESTA JUNINA","FOGUEIRA","MILHO","QUADRILHA","BANDEIRINHA"],
      ["TRABALHO","REUNI√ÉO","PRAZO","META","RESULTADO"],
      ["CIDADE","BAIRRO","PRA√áA","MOVIMENTO","TRADI√á√ÉO"],
      ["SORVETE","DOCE","CASQUINHA","CREMOSO","GELADO"],
      ["AMOR","CORA√á√ÉO","CUIDADO","ABRA√áO","AFETO"],

      ["M√öSICA","FONE","PLAYLIST","RITMO","REFR√ÉO"],
      ["CHAVE","PORTA","FECHADURA","CADEADO","ENTRADA"],
      ["MERCADO","CARRINHO","OFERTA","CAIXA","CUPOM"],
      ["RECREIO","AMIGO","BRINCADEIRA","CORRERIA","INTERVALO"],
      ["ESTETOSC√ìPIO","EXAME","DIAGN√ìSTICO","REM√âDIO","PACIENTE"],
      ["DIRETOR","CENA","ATOR","TRILHA","OSCAR"],
      ["COLO","CARINHO","PROTE√á√ÉO","CHORO","SONINHO"],
      ["FOTO","C√ÇMERA","CLIQUE","√ÅLBUM","MEM√ìRIA"],
      ["PEDESTRE","FAIXA","CAL√áADA","SINAL","ATEN√á√ÉO"],
      ["FOCO","CONCENTRA√á√ÉO","SIL√äNCIO","DISCIPLINA","RESULTADO"],
      ["GUARDA-SOL","CADEIRA","DESCANSO","√ÅGUA","BRISA"],
      ["CAMA","TRAVESSEIRO","SONO","COBERTA","SONHO"],
      ["CARD√ÅPIO","GAR√áOM","PEDIDO","CONTA","SOBREMESA"],
      ["F√â","ORA√á√ÉO","LOUVOR","COMUNH√ÉO","ESPERAN√áA"],
      ["BOLO","VELA","PARAB√âNS","FOTO","ANIVERS√ÅRIO"],
      ["PO√áA","PINGO","ENXURRADA","GOTEIRA","LAMACEIRO"],
      ["ESCRIT√ìRIO","COMPUTADOR","MESA","ARQUIVO","PLANILHA"],
      ["JANTAR","MESA","CONVERSA","FAM√çLIA","RECEITA"],
      ["PLANT√ÉO","EMERG√äNCIA","CUIDADO","ENFERMAGEM","URGEN√áA"],
      ["QUEBRA-CABE√áA","PE√áA","MONTAR","PACI√äNCIA","FIGURA"],
      ["B√çBLIA","PALAVRA","ENSINO","GRA√áA","VERDADE"],
      ["DECOLAGEM","ASA","ALTURA","TURBUL√äNCIA","POUSO"],
      ["CABELO","ESCOVA","CORTE","ESPELHO","SAL√ÉO"],
      ["SACOLA","LOJA","PROMO√á√ÉO","VITRINE","DESCONTO"],
      ["L√ÅPIS","BORRACHA","ESCRITA","CANETA","CADERNO"],
      ["PISCINA","MERGULHO","FRESCOR","TOLBOG√É","BOIA"],
      ["COBERTOR","FRIO","CHOCOLATE","PREGUI√áA","SOPINHA"],
      ["CONVITE","LISTA","ENCONTRO","AMIGOS","MENSAGEM"],
      ["BICICLETA","PEDAL","EQUIL√çBRIO","FREIO","CAPACETE"],
      ["QUADRO","EXPLICA√á√ÉO","AULA","D√öVIDA","APRENDER"],
      ["BANCO","CART√ÉO","PIX","CONTA","SALDO"],

      ["CONTROLE","CANAL","VOLUME","SOF√Å","S√âRIE"],
      ["ESTRADA","DESTINO","PARADA","MAPA","CAMINHO"],
      ["FEIRA","BARRACA","FRUTA","SACOLA","TROCA"],
      ["PRATO","TALHER","SABOR","TEMPER0","APETITE"],
      ["ESTEIRA","CORRIDA","F√îLEGO","META","SUOR"],
      ["MOCHILA","LANCHE","SALA","AMIGO","APRENDER"],
      ["ALIAN√áA","UNI√ÉO","FESTA","VOTOS","CELEBRA√á√ÉO"],
      ["V√çDEO","CURTIDA","COMENT√ÅRIO","TREND","COMPARTILHAR"],
      ["FAROL","SINAL","PARADA","SETAS","PRUD√äNCIA"],
      ["ARROZ","FEIJ√ÉO","CASEIRO","ALMO√áO","PRATO"],
      ["NOTA","PROVA","ESTUDO","BOLETIM","RESULTADO"],
      ["LUA","ESTRELAS","SIL√äNCIO","NOITE","DESCANSO"],
      ["ESFOR√áO","DEDICA√á√ÉO","META","EQUIPE","CONQUISTA"],
      ["DESENHO","L√ÅPIS","COR","CRIATIVIDADE","PAPEL"],
      ["CEIA","UNI√ÉO","GRATID√ÉO","NATAL","FAM√çLIA"],
      ["RECOME√áO","PLANOS","FOGO","ABRA√áO","ANO NOVO"],
      ["DIPLOMA","ORGULHO","FORMATURA","CONQUISTA","FOTO"],
      ["CAMPO","GRAMA","NATUREZA","AR LIVRE","PAZ"],
      ["CARRO","VOLANTE","DIRE√á√ÉO","COMBUST√çVEL","GARAGEM"],
      ["PASSEIO","GUIA","RU√çDO","ALEGRIA","CACHORRO"],
      ["MIAU","SOF√Å","ARRANHADOR","BIGODE","PREGUI√áA"],
      ["GRELHA","CARNE","CARV√ÉO","AMIGOS","CHURRASCO"],
      ["GRUPO","UNI√ÉO","PARCERIA","AMIZADE","ESCOLA"],
      ["EMPATIA","RESPEITO","ATEN√á√ÉO","CUIDADO","GENTILEZA"],
      ["PARQUE","√ÅRVORE","BANCO","CAMINHADA","LAZER"],
      ["NOTIFICA√á√ÉO","ALERTA","MENSAGEM","SOM","CELULAR"],
      ["DESPERTADOR","SONO","PRESSA","CAF√â","MANH√É"],
      ["ROTINA","SOL","COMPROMISSO","TARDE","MOVIMENTO"],
      ["JANTAR","DESCANSO","CONVERSA","NOITE","CASA"],
      ["BIBLIOTECA","SIL√äNCIO","PESQUISA","LEITURA","ESTUDO"],

      ["PEGADA","AREIA","CAMINHADA","MAR","PRAIA"],
      ["PASTEL","CALDO","FILa","FEIRA","TRADI√á√ÉO"],
      ["EQUIPE","UNI√ÉO","SUCESSO","META","TRABALHO"],
      ["PROTE√á√ÉO","SEGURAN√áA","CARINHO","COLO","CRIAN√áA"],
      ["INSPIRA√á√ÉO","ENSINO","FUTURO","PROFESSOR","CUIDADO"],
      ["COMUNIDADE","VIZINHO","BAIRRO","GENTE","CIDADE"],
      ["ENCONTRO","COMUNH√ÉO","PALAVRA","F√â","IGREJA"],
      ["LAR","ACONCHEGO","PAZ","CASA","SEGURAN√áA"],
      ["VERDADE","CONVERSA","APOIO","AMIGO","CONFIA"],
      ["HOR√ÅRIO","DISCIPLINA","ROTINA","COMPROMISSO","TRABALHO"],
      ["EDUCA√á√ÉO","BASE","CONHECIMENTO","FUTURO","ESCOLA"],
      ["ENERGIA","DAN√áA","M√öSICA","FESTA","RISADA"],
      ["CALMA","PAZ","TR√ÇNSITO","RESPIRA","SIL√äNCIO"],
      ["PERSIST√äNCIA","FOR√áA","SUPERAR","DESAFIO","VIT√ìRIA"],
      ["LUZ","CAMINHO","CONFIAN√áA","F√â","ESPERAN√áA"],
      ["VALOR","RECONHECER","OBRIGADO","GRATID√ÉO","RESPEITO"],
      ["SONHO","PLANO","DEDICA√á√ÉO","FUTURO","CONQUISTA"],
      ["ESCOLHAS","TEMPO","VIDA","CAMINHO","APRENDER"],
      ["DIVERS√ÉO","RISADA","JOGO","AMIGOS","MEM√ìRIA"],

      // completa at√© 110 com temas variados:
      ["TEMPERO","SAL","ALHO","CEBOLA","CHEIRO"],
      ["DOCE","BOLO","CHOCOLATE","BALA","SOBREMESA"],
      ["SUSTO","GRITO","MEDO","ESCUR0","BARULHO"],
      ["VIAGEM","ROTEIRO","FOTO","PASSAGEM","GUIA"],
      ["PAPEL","TESOURA","COLA","ARTE","TRABALHO"],
      ["CACHOEIRA","TRILHA","PEDRA","√ÅGUA","NATUREZA"],
      ["SHOW","PALCO","LUZES","MULTID√ÉO","CANTO"],
      ["JOGO","DADO","CARTA","TABULEIRO","SORTE"],
      ["FOTO","SELFIE","POSE","FILTRO","CURTIDA"],
      ["CHAVEIRO","BOLSO","CHAVE","PERDER","ENCONTRAR"],
      ["ENVELOPE","CARTA","CORREIO","SEL0","MENSAGEM"],
      ["CHUVEIRO","BANHO","TOALHA","XAMPU","ESPUMA"],
      ["MALA","Z√çPER","ROUPA","DOBRAR","PESA"],
      ["AEROPORTO","CHECK-IN","PORT√ÉO","FILA","EMBARQUE"],
      ["SALA","VENTILADOR","CALOR","AR-CONDICIONADO","JANELA"],
      ["COZINHA","PRATO","PIA","ESPONJA","LOU√áA"],
      ["PIPOCA","MILHO","SAL","MANTEIGA","BALDE"],
      ["PRAIA","CONCHA","CASTELO","AREIA","CRIAN√áA"],
      ["CHAP√âU","BON√â","CABE√áA","SOL","SOMBRA"],
      ["CAMISA","BOT√ÉO","GOLA","MANGA","ESTAMPa"],
      ["SAPATO","CADAR√áO","MEIA","P√â","CONFORTO"],
    ];

    // ======= ELEMENTOS / UI =======
    const qs = new URLSearchParams(location.search);
    const role = (qs.get("role") || "").toLowerCase(); // host | clue | guess
    const roomParam = (qs.get("room") || "").toUpperCase();

    const elMode = document.getElementById("mode");
    const elRoom = document.getElementById("room");
    const elRound = document.getElementById("round");
    const elPhaseLabel = document.getElementById("phaseLabel");

    const hostUI = document.getElementById("hostUI");
    const clueUI = document.getElementById("clueUI");
    const guessUI = document.getElementById("guessUI");
    const helpUI = document.getElementById("helpUI");

    const elWords = document.getElementById("words");
    const elTargetBox = document.getElementById("targetBox");
    const elTargetWord = document.getElementById("targetWord");
    const elTargetN = document.getElementById("targetN");

    const linkClue = document.getElementById("linkClue");
    const linkGuess = document.getElementById("linkGuess");

    const clueList = document.getElementById("clueList");
    const dupHint = document.getElementById("dupHint");
    const clueCountText = document.getElementById("clueCountText");
    const cluesHiddenHint = document.getElementById("cluesHiddenHint");
    const hostCluesHelp = document.getElementById("hostCluesHelp");
    const bulkRow = document.getElementById("bulkRow");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const unselectAllBtn = document.getElementById("unselectAllBtn");

    const guessWait = document.getElementById("guessWait");
    const guessClueList = document.getElementById("guessClueList");

    const clueTarget = document.getElementById("clueTarget");
    const clueName = document.getElementById("clueName");
    const clueText = document.getElementById("clueText");
    const clueStatus = document.getElementById("clueStatus");

    const newRoomBtn = document.getElementById("newRoomBtn");
    const newCardBtn = document.getElementById("newCardBtn");
    const pickBtn = document.getElementById("pickBtn");
    const revealCluesBtn = document.getElementById("revealCluesBtn");
    const publishCluesBtn = document.getElementById("publishCluesBtn");
    const clearCluesBtn = document.getElementById("clearCluesBtn");
    const sendClueBtn = document.getElementById("sendClueBtn");

    function fisherYates(arr){
      const a = arr.slice();
      for (let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }
    function code4(){
      const chars="ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s="";
      for(let i=0;i<4;i++) s+=chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function baseUrl(){ return location.origin + location.pathname; }
    function makeLink(r, rm){ return `${baseUrl()}?role=${r}&room=${rm}`; }

    function renderWords(words){
      elWords.innerHTML = "";
      (words || []).forEach((w,i)=>{
        const div = document.createElement("div");
        div.className = "word";
        div.innerHTML = `<span>${w}</span><span class="idx">${i+1}</span>`;
        elWords.appendChild(div);
      });
    }
    function normalizeClue(s){ return (s||"").trim().toLowerCase(); }

    function phaseName(p){
      if (p === "collecting") return "Coletando";
      if (p === "revealed") return "Revelado (sele√ß√£o)";
      if (p === "published") return "Enviado ao adivinhador";
      return p || "‚Äî";
    }

    // ======= FIREBASE INIT =======
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ======= FIRESTORE REFS =======
    function roomRef(rm){ return doc(db, "rooms", rm); }
    function cluesColRef(rm){ return collection(db, "rooms", rm, "clues"); }

    // ======= ESTADO =======
    let room = roomParam || "";

    // ======= ACTIONS =======
    async function createRoom(){
      room = code4();
      const deckOrder = fisherYates([...DECK.keys()]);
      const deckPos = 0;
      const firstIdx = deckOrder[deckPos];

      await setDoc(roomRef(room), {
        room,
        round: 1,
        card: DECK[firstIdx],
        cardIndex: firstIdx,
        targetN: null,
        targetWord: null,
        deckOrder,
        deckPos,
        phase: "collecting",
        publishedClues: [],
        updatedAt: serverTimestamp()
      });

      history.replaceState(null, "", makeLink("host", room));
      setupUI();
      attachListeners();
    }

    async function clearClues(){
      if (!room) return;
      const col = cluesColRef(room);
      const all = await getDocs(col);
      await Promise.all(all.docs.map(d => deleteDoc(d.ref)));

      await setDoc(roomRef(room), {
        phase: "collecting",
        publishedClues: [],
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function nextCard(){
      const snap = await getDoc(roomRef(room));
      if (!snap.exists()) return;

      const data = snap.data();
      const order = Array.isArray(data.deckOrder) ? data.deckOrder : fisherYates([...DECK.keys()]);
      let pos = Number.isFinite(data.deckPos) ? data.deckPos : 0;

      pos = (pos + 1) % order.length;
      const cardIdx = order[pos];

      await setDoc(roomRef(room), {
        round: (data.round || 1) + 1,
        card: DECK[cardIdx],
        cardIndex: cardIdx,
        targetN: null,
        targetWord: null,
        deckOrder: order,
        deckPos: pos,
        phase: "collecting",
        publishedClues: [],
        updatedAt: serverTimestamp()
      }, { merge: true });

      // limpa as dicas ao iniciar nova rodada (pra ficar pr√°tico)
      await clearClues();
    }

    async function pickTarget(){
      const snap = await getDoc(roomRef(room));
      if (!snap.exists()) return;
      const data = snap.data();
      const card = data.card;
      if (!Array.isArray(card) || card.length !== 5) return;

      const n = Math.floor(Math.random()*5)+1;
      const tw = card[n-1];

      await setDoc(roomRef(room), {
        targetN: n,
        targetWord: tw,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function sendClue(){
      const name = (clueName.value || "").trim();
      const txt = (clueText.value || "").trim();
      if (!txt) { clueStatus.textContent = "Digite sua dica."; return; }

      const roomSnap = await getDoc(roomRef(room));
      if (!roomSnap.exists()) return;
      const roomData = roomSnap.data();

      if (roomData.phase !== "collecting"){
        clueStatus.textContent = "Rodada fechada pelo host. Aguarde a pr√≥xima carta.";
        return;
      }

      const oneWord = txt.split(/\s+/)[0];

      await addDoc(cluesColRef(room), {
        name: name || "Jogador",
        clue: oneWord,
        clueNorm: normalizeClue(oneWord),
        createdAt: serverTimestamp()
      });

      clueText.value = "";
      clueStatus.textContent = "Dica enviada ‚úÖ";
      setTimeout(()=>clueStatus.textContent="", 1400);
    }

    async function revealClues(){
      await setDoc(roomRef(room), {
        phase: "revealed",
        publishedClues: [],
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    async function publishSelectedClues(){
      // pega ids marcados
      const checks = document.querySelectorAll('input[data-clue-id]');
      const selectedIds = [];
      checks.forEach(ch => { if (ch.checked) selectedIds.push(ch.getAttribute("data-clue-id")); });

      const snap = await getDocs(cluesColRef(room));
      const all = [];
      snap.forEach(d => all.push({ id:d.id, ...d.data() }));

      const selected = all
        .filter(it => selectedIds.includes(it.id))
        .map(it => ({
          name: it.name || "Jogador",
          clue: it.clue || "",
          clueNorm: it.clueNorm || normalizeClue(it.clue)
        }));

      await setDoc(roomRef(room), {
        phase: "published",
        publishedClues: selected,
        updatedAt: serverTimestamp()
      }, { merge: true });
    }

    // ======= REALTIME LISTENERS =======
    function attachListeners(){
      // room snapshot
      onSnapshot(roomRef(room), (snap) => {
        if (!snap.exists()) return;
        const data = snap.data();

        const phase = data.phase || "collecting";
        elRoom.textContent = room;
        elRound.textContent = String(data.round ?? "‚Äî");
        elPhaseLabel.textContent = phaseName(phase);

        linkClue.textContent = makeLink("clue", room);
        linkGuess.textContent = makeLink("guess", room);

        const card = data.card || [];
        const tn = data.targetN;
        const tw = data.targetWord;
        const published = Array.isArray(data.publishedClues) ? data.publishedClues : [];

        if (role === "host"){
          renderWords(card);

          if (tw){
            elTargetBox.style.display = "block";
            elTargetWord.textContent = tw;
            elTargetN.textContent = String(tn);
          } else {
            elTargetBox.style.display = "none";
          }

          // bot√µes por fase
          revealCluesBtn.disabled = (phase !== "collecting");
          publishCluesBtn.disabled = (phase === "collecting");

          // dica do host: se fase coletando, ocultar lista
          const showClues = (phase === "revealed" || phase === "published");
          cluesHiddenHint.style.display = showClues ? "none" : "block";
          hostCluesHelp.style.display = (phase === "revealed") ? "block" : "none";
          bulkRow.style.display = (phase === "revealed") ? "flex" : "none";

          // se j√° publicou, pode manter checkboxes vis√≠veis mas travados
          const lockChecks = (phase === "published");
          const checkEls = document.querySelectorAll('input[data-clue-id]');
          checkEls.forEach(ch => ch.disabled = lockChecks);

          // (s√≥ pra feedback r√°pido) quantidade publicada
          if (phase === "published"){
            // nada visual extra obrigat√≥rio
          }
        }

        if (role === "clue"){
          clueTarget.textContent = tw ? tw : "Aguardando alvo‚Ä¶";

          const locked = (phase !== "collecting");
          sendClueBtn.disabled = locked;
          clueText.disabled = locked;
          clueName.disabled = locked;
          if (locked) clueStatus.textContent = "Rodada fechada. Aguarde a pr√≥xima carta.";
          else clueStatus.textContent = "";
        }

        if (role === "guess"){
          guessClueList.innerHTML = "";
          if (!published.length){
            guessWait.style.display = "block";
          } else {
            guessWait.style.display = "none";
            published.forEach(it => {
              const div = document.createElement("div");
              div.className = "clue";
              div.innerHTML = `<span><b>${it.name}:</b> ${it.clue}</span><span class="small"></span>`;
              guessClueList.appendChild(div);
            });
          }
        }
      });

      // clues snapshot (host v√™ contagem sempre; lista s√≥ aparece ap√≥s revelar)
      onSnapshot(cluesColRef(room), (snap) => {
        const items = [];
        snap.forEach(d => items.push({ id:d.id, ...d.data() }));

        items.sort((a,b)=>{
          const ta = a.createdAt?.seconds || 0;
          const tb = b.createdAt?.seconds || 0;
          return ta - tb;
        });

        // contagem sempre
        clueCountText.textContent = `${items.length} recebida(s)`;

        if (role !== "host") return;

        // Descobre fase atual (para decidir se lista aparece)
        getDoc(roomRef(room)).then(roomSnap => {
          if (!roomSnap.exists()) return;
          const phase = (roomSnap.data().phase || "collecting");

          const showClues = (phase === "revealed" || phase === "published");
          clueList.innerHTML = "";
          dupHint.textContent = "";

          if (!showClues){
            // n√£o renderiza dicas na fase de coleta
            return;
          }

          const normCount = new Map();
          items.forEach(it=>{
            const k = it.clueNorm || normalizeClue(it.clue);
            normCount.set(k, (normCount.get(k)||0) + 1);
          });

          items.forEach(it=>{
            const key = it.clueNorm || normalizeClue(it.clue);
            const dup = (normCount.get(key) || 0) > 1;

            const row = document.createElement("div");
            row.className = "clue";

            const disabled = (phase === "published") ? "disabled" : "";
            row.innerHTML = `
              <span>
                <b>${it.name||"Jogador"}:</b> ${it.clue||""}
                <span class="small">${dup ? " (duplicada ‚ö†Ô∏è)" : ""}</span>
              </span>
              <span>
                <input type="checkbox" data-clue-id="${it.id}" title="Marque para enviar ao adivinhador" ${disabled} />
              </span>
            `;
            clueList.appendChild(row);
          });

          const dups = [...normCount.entries()].filter(([_,v])=>v>1).map(([k])=>k);
          dupHint.textContent = dups.length ? `Duplicadas: ${dups.join(", ")}` : "Sem duplicadas.";
        });
      });
    }

    // ======= UI =======
    function setupUI(){
      elRoom.textContent = room || "‚Äî";
      elMode.textContent = role ? role.toUpperCase() : "‚Äî";

      hostUI.style.display = "none";
      clueUI.style.display = "none";
      guessUI.style.display = "none";
      helpUI.style.display = "none";

      if (role === "host") hostUI.style.display = "block";
      else if (role === "clue") clueUI.style.display = "block";
      else if (role === "guess") guessUI.style.display = "block";
      else helpUI.style.display = "block";
    }

    // ======= EVENTOS =======
    newRoomBtn.addEventListener("click", createRoom);
    newCardBtn.addEventListener("click", nextCard);
    pickBtn.addEventListener("click", pickTarget);
    revealCluesBtn.addEventListener("click", revealClues);
    publishCluesBtn.addEventListener("click", publishSelectedClues);
    clearCluesBtn.addEventListener("click", clearClues);
    if (sendClueBtn) sendClueBtn.addEventListener("click", sendClue);

    selectAllBtn.addEventListener("click", () => {
      document.querySelectorAll('input[data-clue-id]').forEach(ch => { if (!ch.disabled) ch.checked = true; });
    });
    unselectAllBtn.addEventListener("click", () => {
      document.querySelectorAll('input[data-clue-id]').forEach(ch => { if (!ch.disabled) ch.checked = false; });
    });

    // ======= INIT =======
    setupUI();

    if (role === "host" && !room){
      await createRoom();
    } else if ((role === "clue" || role === "guess" || role === "host") && room){
      attachListeners();
    }
  </script>
</body>
</html>
